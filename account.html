<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WorkHub - Account</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .transaction {
      background: #f9f9f9;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <header>
    <h1>My Account</h1>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="project.html">Projects</a>
      <a href="deposit.html">Deposit</a>
      <a href="withdraw.html">Withdraw</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>Balances</h2>
      <p>Total Balance: $<span id="totalBalance">0.00</span></p>
      <p>Available Balance: $<span id="availableBalance">0.00</span></p>
    </section>

    <section>
      <h2>Recent Transactions</h2>
      <div id="transactionList"></div>
    </section>
  </main>

  <audio id="notifySound" src="notify.mp3" preload="auto"></audio>

  <script>
    function getUserTransactions() {
      const allTransactions = JSON.parse(localStorage.getItem("transactions")) || [];
      const currentUser = localStorage.getItem("loggedInUser");
      return allTransactions.filter(txn => txn.user === currentUser);
    }

    function getUserBalance() {
      const balances = JSON.parse(localStorage.getItem("balances")) || {};
      const currentUser = localStorage.getItem("loggedInUser");
      return balances[currentUser] || 0;
    }

    function updateBalanceUI() {
      const balance = getUserBalance();
      document.getElementById("totalBalance").textContent = balance.toFixed(2);
      document.getElementById("availableBalance").textContent = balance.toFixed(2);
    }

    function updateTransactionList() {
      const transactions = getUserTransactions();
      const transactionList = document.getElementById("transactionList");

      // Sort transactions by date and time DESCENDING
      transactions.sort((a, b) => {
        const dateTimeA = new Date(`${a.date}T${a.time}`);
        const dateTimeB = new Date(`${b.date}T${b.time}`);
        return dateTimeB - dateTimeA;
      });

      transactionList.innerHTML = "";

      transactions.forEach(txn => {
        const div = document.createElement("div");
        div.className = "transaction";
        div.innerHTML = `
          <strong>${txn.type}</strong><br>
          Amount: $${parseFloat(txn.amount).toFixed(2)}<br>
          Date: ${txn.date} ${txn.time}<br>
          Ref: ${txn.reference || 'N/A'}
        `;
        transactionList.appendChild(div);
      });
    }

    function checkForNewPayments() {
      const newPaid = JSON.parse(localStorage.getItem("newPaid")) || [];
      const currentUser = localStorage.getItem("loggedInUser");

      const userNewPaid = newPaid.filter(txn => txn.user === currentUser);
      if (userNewPaid.length > 0) {
        // Add to transactions
        const allTransactions = JSON.parse(localStorage.getItem("transactions")) || [];
        allTransactions.push(...userNewPaid);
        localStorage.setItem("transactions", JSON.stringify(allTransactions));

        // Play notification sound
        const sound = document.getElementById("notifySound");
        sound.play();

        // Remove from newPaid
        const remaining = newPaid.filter(txn => txn.user !== currentUser);
        localStorage.setItem("newPaid", JSON.stringify(remaining));

        // Update balance
        const balances = JSON.parse(localStorage.getItem("balances")) || {};
        balances[currentUser] = (balances[currentUser] || 0) + userNewPaid.reduce((sum, txn) => sum + parseFloat(txn.amount), 0);
        localStorage.setItem("balances", JSON.stringify(balances));
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      checkForNewPayments();
      updateBalanceUI();
      updateTransactionList();
    });
  </script>
</body>
</html>
