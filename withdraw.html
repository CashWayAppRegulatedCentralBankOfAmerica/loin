<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nova Prime | Deposit & Withdraw</title>
  <link rel="icon" type="image/png" href="nova_favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function () {
      emailjs.init("WNEjs_ksvkD2yiWv1");
    })();
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <header class="bg-white shadow p-4 flex items-center justify-between">
    <div class="text-xl font-bold text-green-600">Nova Prime</div>
  </header>

  <main class="max-w-md mx-auto mt-10 bg-white p-6 pb-20 rounded-lg shadow space-y-12">
    
    <!-- Deposit Form -->
    <section>
      <h2 class="text-lg font-semibold mb-4">Deposit (KES)</h2>
      <form id="depositForm">
        <label class="block mb-2 text-sm font-medium text-gray-700">Amount in KES:</label>
        <input type="number" id="depositKES" required class="w-full border border-gray-300 p-2 rounded mb-1" min="655" step="1" />
        <p id="convertedUSD" class="text-xs text-gray-500 italic mb-4"></p>

        <label class="block mb-2 text-sm font-medium text-gray-700">Mobile Number (User ID):</label>
        <input type="text" id="depositPhone" required class="w-full border border-gray-300 p-2 rounded mb-4" />

        <label class="block mb-2 text-sm font-medium text-gray-700">Reference Note (User Email):</label>
        <input type="text" id="depositReference" required class="w-full border border-gray-300 p-2 rounded mb-4" />

        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">Deposit</button>
      </form>
    </section>

    <!-- Withdrawal Form -->
    <section>
      <h2 class="text-lg font-semibold mb-4">Withdraw (USD)</h2>
      <form id="withdrawForm">
        <label class="block mb-2 text-sm font-medium text-gray-700">Amount to Withdraw ($):</label>
        <input type="number" id="withdrawAmount" required class="w-full border border-gray-300 p-2 rounded mb-1" min="20" step="0.01" />
        <p id="liveKESWithdraw" class="text-xs text-gray-500 italic mb-4"></p>

        <label class="block mb-2 text-sm font-medium text-gray-700">Mobile Number (User ID):</label>
        <input type="text" id="withdrawPhone" required class="w-full border border-gray-300 p-2 rounded mb-4" />

        <label class="block mb-2 text-sm font-medium text-gray-700">Reference Note (User Email):</label>
        <input type="text" id="withdrawReference" required class="w-full border border-gray-300 p-2 rounded mb-4" />

        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Withdraw</button>
      </form>
    </section>

  </main>

  <footer class="fixed bottom-0 left-0 w-full bg-white text-center py-4 text-gray-500 text-sm z-50 shadow">
    <p>&copy; 2025 Nova Prime Inc. All rights reserved.</p>
    <div class="space-x-4">
      <a href="privacy" class="hover:text-green-600">Privacy</a>
      <a href="terms" class="hover:text-green-600">Terms</a>
      <a href="help" class="hover:text-green-600">Help</a>
    </div>
  </footer>

  <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>

  <script>
    const depositForm = document.getElementById("depositForm");
    const withdrawForm = document.getElementById("withdrawForm");
    const successSound = document.getElementById("successSound");

    const USD_RATE = 131;

    // Deposit
    depositForm.addEventListener("submit", function(e) {
      e.preventDefault();

      const kesAmount = parseFloat(document.getElementById("depositKES").value);
      const usdAmount = kesAmount / USD_RATE;
      const phone = document.getElementById("depositPhone").value.trim();
      const reference = document.getElementById("depositReference").value.trim();

      let balance = parseFloat(localStorage.getItem("balance") || "0");
      balance += usdAmount;
      localStorage.setItem("balance", balance.toFixed(2));

      const transaction = {
        type: "Deposit",
        amount: usdAmount.toFixed(2),
        date: new Date().toLocaleString(),
        reference,
        phone
      };
      const transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
      transactions.unshift(transaction);
      localStorage.setItem("transactions", JSON.stringify(transactions));

      emailjs.send("service_t8vherg", "template_sqgf423", {
        phone,
        amount: usdAmount.toFixed(2) + " USD",
        reference,
        date: new Date().toLocaleDateString(),
        time: new Date().toLocaleTimeString(),
      });

      alert(`Deposit successful! ${usdAmount.toFixed(2)} USD credited to your account.`);
      depositForm.reset();
      document.getElementById("convertedUSD").textContent = "";
      successSound.play();
    });

    document.getElementById("depositKES").addEventListener("input", function () {
      const kes = parseFloat(this.value);
      const display = document.getElementById("convertedUSD");
      if (!isNaN(kes)) {
        display.textContent = `USD Equivalent: ${(kes / USD_RATE).toFixed(2)} USD`;
      } else {
        display.textContent = "";
      }
    });

    // Withdraw
    withdrawForm.addEventListener("submit", function(e) {
      e.preventDefault();

      const amount = parseFloat(document.getElementById("withdrawAmount").value).toFixed(2);
      const phone = document.getElementById("withdrawPhone").value.trim();
      const reference = document.getElementById("withdrawReference").value.trim();

      let balance = parseFloat(localStorage.getItem("balance") || "0");

      if (balance < amount) {
        alert("Insufficient balance.");
        return;
      }

      if (balance - amount < 20) {
        alert("You must leave at least $20 in your account after withdrawal.");
        return;
      }

      balance -= amount;
      localStorage.setItem("balance", balance.toFixed(2));

      const transaction = {
        type: "Withdrawal",
        amount,
        date: new Date().toLocaleString(),
        reference,
        phone
      };
      const transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
      transactions.unshift(transaction);
      localStorage.setItem("transactions", JSON.stringify(transactions));

      emailjs.send("service_t8vherg", "template_sqgf423", {
        phone,
        amount: amount + " USD",
        reference,
        date: new Date().toLocaleDateString(),
        time: new Date().toLocaleTimeString(),
      });

      alert("Withdrawal successful. Your M-PESA account will be credited shortly.");
      withdrawForm.reset();
      document.getElementById("liveKESWithdraw").textContent = "";
      successSound.play();
    });

    // Live KES Calculator for Withdrawal
    document.getElementById("withdrawAmount").addEventListener("input", function () {
      const usd = parseFloat(this.value);
      const liveKES = document.getElementById("liveKESWithdraw");
      if (!isNaN(usd)) {
        liveKES.textContent = `KES Equivalent: ${(usd * USD_RATE).toFixed(2)} KES`;
      } else {
        liveKES.textContent = "";
      }
    });
  </script>
</body>
</html>
